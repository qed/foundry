# Artifacts (Phases 096–101)

> File storage and management module: schema, upload UI, browser, entity linking, full-text search, folder organization.
> Key files: `components/artifacts/`, `app/api/projects/[projectId]/artifacts/`, `lib/artifacts/`

**096** — Artifacts Database & Storage Schema — SQL migration 008_artifacts_schema.sql creating 2 tables: artifact_folders with hierarchical self-referencing parent_folder_id for folder organization with unique name constraint per project+parent and CASCADE delete for nested cleanup, artifacts for file metadata with project scoping and folder placement via folder_id FK to artifact_folders plus file_type/file_size/storage_path fields with unique storage_path constraint and optional content_text for future full-text search and uploaded_by tracking; RLS policies using is_project_member() for tenant isolation; artifact_project_member() SECURITY DEFINER helper for future entity linking; 7 indexes for project/folder/uploader/date/type queries; auto-update triggers on updated_at; updated TypeScript types with convenience aliases ArtifactFolder/Artifact.

**097** — Artifact Upload UI — lib/artifacts/file-types.ts with ACCEPTED_EXTENSIONS map for 13 file types across document/image/spreadsheet/audio categories, MAX_FILE_SIZE 50MB, validateFile client-side validation, getFileCategory/formatFileSize/getAcceptString utilities; GET/POST /api/projects/[projectId]/artifacts listing artifacts by folder with POST multipart upload to Supabase Storage using sanitized timestamped storage paths, file type and size server validation, artifact metadata insert with cleanup on failure; UploadZone component with drag-drop zone plus file browser input, client-side file validation on add, file list with category-colored icons FileText/Image/Music/Table2, progress bars during upload with simulated progress, CheckCircle2 success and AlertCircle error indicators, upload-all button for pending batch, compact mode option, multiple/single file modes; FileTypeIcon component with color-coded category icons for document/image/audio/spreadsheet types.

**098** — Artifact Browser & Management — Done. No detailed description recorded in the phase history paragraph.

**099** — Artifact Linking to Entities — Done. No detailed description recorded in the phase history paragraph.

**100** — Artifact Search & Indexing — SQL migration 016_artifact_search.sql adding processing_status VARCHAR column with CHECK constraint for pending/extracting_text/complete/failed states, search_vector TSVECTOR column with GIN index for fast full-text search, update_artifacts_tsvector trigger function auto-populating search_vector from name+content_text on INSERT/UPDATE, backfill of existing artifacts; lib/artifacts/extraction.ts text extraction utility supporting PDF via pdf-parse PDFParse class with getText, DOCX via mammoth extractRawText, CSV via papaparse with pipe-delimited row joins, MD/TXT direct TextDecoder decode, 500KB max content truncation with whitespace normalization; POST /api/artifacts/search endpoint with project membership validation, Supabase textSearch websearch mode on search_vector column, optional folder_id filter, content_preview first 200 chars, search_context snippet with 60-char padding around match, query execution timing; GET /api/artifacts/[id]/content endpoint returning full extracted text with 202 status for in-progress extraction; upload route enhanced with inline text extraction after file upload setting processing_status extracting_text then complete/failed, content_text populated for searchable file types; ArtifactBrowser search bar with debounced 300ms input, result count display, clear button, search vs browse mode switching hiding folders during search, no-results empty state; dependencies pdf-parse mammoth papaparse with TypeScript type definitions; processing_status added to artifacts TypeScript types.

**101** — Artifact Folders & Organization — PATCH/DELETE/GET endpoints for individual artifact folders at /api/projects/[projectId]/artifacts/folders/[folderId] with rename via name field and move via parent_folder_id field; getFolderDepth and getSubtreeDepth recursive helpers for depth validation ensuring 3-level max; isDescendant circular reference prevention for folder moves; countFolderContents recursive content counting for delete confirmation; cascade delete removing folder and all nested children with content count response; name uniqueness enforcement within parent folder returning 409 on conflict; enhanced GET /folders with ?all=true parameter returning flat list of all project folders for move dialogs; enhanced POST /folders with depth validation walking parent chain to enforce MAX_DEPTH=3; FolderContextMenu component with Rename/New Subfolder/Move/Delete options, viewport-aware positioning, click-outside and Escape dismiss; ArtifactBrowser enhanced with folder context menu state, right-click and hover three-dot menu on folder items, inline folder rename with input field Enter/Escape/blur handling, folder delete via DELETE API with confirmation dialog, subfolder creation navigating into parent then showing new folder input, breadcrumb name updates on folder rename.
