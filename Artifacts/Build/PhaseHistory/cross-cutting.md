# Cross-Cutting & Admin (Phases 105–119)

> Platform-wide features: comments system, knowledge graph, organization console, real-time presence, audit trail.
> Key files: `app/api/projects/[projectId]/activity-log/`, `lib/activity/`, `lib/realtime/`, `components/presence/`, `app/org/[orgSlug]/settings/`

**105** — Comments System Foundation Schema — SQL migration 009_comments_schema.sql creating polymorphic comments table supporting all entity types idea/feature_node/requirement_doc/blueprint/work_order/feedback via entity_type CHECK constraint and entity_id UUID reference; threaded replies via self-referencing parent_comment_id with CASCADE delete; soft delete via deleted_at timestamp; resolution tracking via is_resolved boolean on root comments; anchored comments via anchor_data JSONB for inline text selection references; RLS policies using is_project_member() for tenant isolation; comment_project_member() SECURITY DEFINER helper; 6 indexes including composite project+entity_type+entity_id; auto-update trigger on updated_at; updated TypeScript types with convenience aliases Comment/CommentEntityType.

**109** — Knowledge Graph Schema — SQL migration 010_knowledge_graph_schema.sql creating entity_connections table for cross-module relationship tracking between ideas/features/blueprints/work_orders/feedback/artifacts with 7 connection types references/depends_on/relates_to/implements/derived_from/conflicts_with/complements; unique constraint preventing duplicate connections; is_auto_detected boolean with JSONB metadata for confidence scores and evidence; bidirectional_connections view mirroring symmetric types relates_to/conflicts_with/complements for both-direction queries; filtered index on manual connections for common lookup patterns; RLS using is_project_member(); 6 indexes plus filtered manual lookup; updated TypeScript types with convenience aliases EntityConnection/EntityConnectionType/GraphEntityType.

**113** — Organization Console — full admin settings UI at /org/[slug]/settings accessible only to org admins; SQL migration 011_org_console_schema.sql adding description and avatar_url columns to organizations; PATCH /api/orgs/[orgId] for updating org name/description/avatar, DELETE /api/orgs/[orgId] for founding-admin-only org deletion with cascading cleanup; GET /api/orgs/[orgId]/members for member list with profile enrichment; PATCH /api/orgs/[orgId]/members/[memberId] for role changes with last-admin and self-modification guards, DELETE for member removal; four-tab console: General Settings with name/description editing and slug display, Members tab with search/role filter/role change dropdown/remove with confirmation dialog, Projects tab with project list and open links, Danger Zone with type-slug-to-confirm deletion dialog; server component with admin role check redirecting non-admins; glass-panel styling with accent-error border on danger zone; updated TypeScript types adding description and avatar_url to organizations.

**117** — Real-Time Presence — Supabase Realtime presence tracking per project channel; usePresence hook subscribing to project:{id}:presence channel with automatic join/leave/sync events and module tracking; useCurrentModule hook deriving active module from URL pathname; presence data includes user_id, display_name, avatar_url, current_module; OnlineIndicator component with green/gray dot and optional label; OnlineUsersList with overlapping avatar stack and overflow counter; PresenceSidebar showing users grouped by module with avatar rows; PresenceWidget integrated into sidebar footer with expandable detail panel and collapsed badge mode; HeaderPresence in header bar showing avatars of users in the same module; presence updates on module navigation without channel re-subscription; automatic cleanup on disconnect via Supabase Realtime.

**119** — Audit Trail & Activity Log — SQL migration 012_activity_log_schema.sql creating immutable activity_log table with project_id, user_id, entity_type, entity_id, action, JSONB details, ip_address, user_agent fields; RLS via is_project_member() for SELECT and INSERT only with no UPDATE/DELETE policies; 5 indexes including composite project+created_at DESC and project+user+created_at; logActivity() server utility in lib/activity/logging.ts using service client with fire-and-forget error handling; formatAction/formatEntityType/getActionColor display utilities in lib/activity/utils.ts mapping 30+ action types to human-readable labels; GET /api/projects/[projectId]/activity-log endpoint with pagination, filtering by user/action/entity_type/entity_id/date_range/search, profile enrichment; ActivityLogViewer component with debounced filter changes and load-more pagination; ActivityFilters with search input, entity type dropdown, action category dropdown, date range pickers; ActivityItem showing user avatar, action label with color coding, entity type badge, timestamp, optional change summary; activity-log page at /org/[orgSlug]/project/[projectId]/activity-log; updated TypeScript types with ActivityLog alias.
