# Assembly Floor (Phases 061–073)

> Work order management module: schema, layout, work order CRUD, detail view, kanban board with drag-and-drop, table view, phase management, agent chat.
> Key files: `components/floor/`, `app/api/projects/[projectId]/work-orders/`, `app/api/projects/[projectId]/phases/`, `lib/agent/floor-context.ts`, `app/api/agent/floor/`

**061** — Assembly Floor Database Schema — SQL migration 005_assembly_floor_schema.sql creating 3 tables: phases with project-scoped name uniqueness and planned/active/completed status tracking with position ordering, work_orders with comprehensive fields including title/description/description_json/acceptance_criteria/implementation_plan/implementation_plan_json plus backlog/ready/in_progress/in_review/done status and critical/high/medium/low priority with feature_node linkage and assignee tracking, work_order_activity for immutable audit trail with action and JSONB details; RLS policies on all 3 tables using is_project_member() for direct project tables; new work_order_project_member() SECURITY DEFINER function for indirect project membership checks on activity table; activity table intentionally has no UPDATE or DELETE policies to enforce immutability; 11 indexes including composite project_id+phase_id; CHECK constraints for status and priority enums; auto-update triggers on phases.updated_at and work_orders.updated_at; blueprint_id FK deferred to Phase 046; updated TypeScript types with full Row/Insert/Update definitions and convenience aliases Phase/WorkOrder/WorkOrderActivity/WorkOrderStatus/WorkOrderPriority/PhaseStatus.

**062** — Assembly Floor Page Layout — FloorClient orchestrator managing kanban/table view toggle persisted to localStorage and URL query param with responsive agent panel auto-collapse below 1200px; FloorHeader with module icon, progress badge showing X/Y work orders complete with percentage, view toggle button group Kanban/Table with accent-cyan active states, disabled New Work Order button placeholder, agent panel toggle; PhaseNavigation with horizontal scrollable tabs including All Phases default tab plus individual phase tabs with status color dots planned/active/completed and per-phase progress counts, scroll arrows for overflow, disabled Add Phase placeholder; FloorContent with kanban board view showing 5 status columns Backlog/Ready/In Progress/In Review/Done with count badges and glass-panel work order cards showing title and priority dot, and table view with 7-column layout Title/Status/Priority/Assignee/Phase/Feature/Updated with status badges and priority indicators; FloorRightPanel agent chat placeholder matching Pattern Shop pattern with Bot icon and disabled input; GET /api/projects/[projectId]/work-orders endpoint with optional phaseId filter and project membership validation; GET /api/projects/[projectId]/phases endpoint ordered by position; server component fetches work order status counts for initial stats; scrollbar-hide utility class added to globals.css.

**063** — Create Work Order Manual — POST /api/projects/[projectId]/work-orders endpoint with server-side validation of title 3-255 chars and priority enum, auto-position calculation via MAX sibling position+1, work_order_activity audit log entry on creation; GET /api/projects/[projectId]/members endpoint fetching project_members enriched with profiles table display_name and avatar_url; CreateWorkOrderModal slide-over panel from right edge with 200ms slide-in-right animation, 460px max width, 7 form fields: title with live character count and 3-char minimum validation, description textarea with 5000 char limit, acceptance criteria textarea, priority 4-button selector with color-coded dots for critical/high/medium/low, assignee dropdown populated from project members API, phase dropdown from phases list, linked feature dropdown from flattened feature tree hierarchy; form fetches members and feature nodes on modal open, resets all fields on close, disables inputs during submission, shows inline error messages; FloorHeader New Work Order button enabled with onNewWorkOrder callback; FloorClient wired with createModalOpen state and fetchKey increment pattern triggering data refetch after successful creation.

**064** — Work Order Detail View — GET /api/projects/[projectId]/work-orders/[workOrderId] fetching single work order enriched with creator profile, assignee profile, phase name, and feature node title via parallel queries; PATCH endpoint with field-level change detection for title/status/priority/assignee_id/phase_id/feature_node_id/description/acceptance_criteria/implementation_plan creating work_order_activity entries for each change with from/to details; GET /api/projects/[projectId]/work-orders/[workOrderId]/activity endpoint with profile-enriched activity feed in reverse chronological order; WorkOrderDetail slide-over component at 560px max-width with slide-in-right animation triggered by clicking kanban cards or table rows; inline editable title with pencil icon on hover and Enter/Escape keyboard handling; status and priority inline dropdowns with color-coded options and optimistic updates; assignee dropdown populated from project members with avatar display; phase dropdown from phases list; editable description/acceptance_criteria/implementation_plan text sections with Save/Cancel buttons; acceptance criteria rendered as bullet list stripping markdown markers; activity feed showing formatted action descriptions with user avatars and timeAgo timestamps; comments section placeholder for Phase 078; FloorContent updated with onWorkOrderClick prop wired to kanban cards and table rows; FloorClient managing selectedWorkOrderId state with fetchKey refetch on updates.

**065** — Kanban Board with Drag-and-Drop — KanbanBoard component using @dnd-kit/core with DndContext, PointerSensor with 5px activation constraint, closestCenter collision detection; 5 droppable KanbanColumn components for backlog/ready/in_progress/in_review/done with status-colored dot headers, count badges, and cyan highlight on drag-over; DraggableCard wrapping CardContent showing title with line-clamp-2, priority color dot with label, acceptance criteria count, and assignee avatar placeholder; DragOverlay with ghost card shadow and 1deg rotation; optimistic status moves via optimisticMoves state map with 3-second auto-clear; columns scroll vertically with max-height calc(100vh-220px); FloorClient handleStatusChange callback performing optimistic setWorkOrders state update then PATCH API call with refetch fallback on error; extracted kanban into dedicated kanban-board.tsx from floor-content.tsx which now delegates to KanbanBoard component.

**067** — Work Order List/Table View — WorkOrderTable component in components/floor/work-order-table.tsx with 8-column sortable table: checkbox selection, title, status badge, priority dot, assignee avatar, phase name, feature name, relative timestamp; column header click cycles sort asc/desc/none with ArrowUp/ArrowDown/ChevronsUpDown icons; grouping buttons for none/status/phase/assignee/priority with collapsible group headers showing item counts; row selection with select-all checkbox and cyan highlight for selected rows; enriched data display using MemberInfo and FeatureInfo lookup maps for assignee avatars and phase/feature name resolution; responsive column hiding Phase on <lg and Feature on <xl; FloorContent updated to delegate table view to WorkOrderTable accepting phases/members/features/selectedIds/onSelectionChange props; FloorClient enhanced to fetch project members and feature tree in parallel with feature tree recursive flattening for lookup enrichment.

**069** — Work Order Phases — full phase CRUD management; POST /api/projects/[projectId]/phases endpoint creating phases with auto-calculated position; PATCH/DELETE /api/projects/[projectId]/phases/[phaseId] for updating name/description/status/position and deleting with work order unphasing; PhaseNavigation enhanced from placeholder to interactive: enabled Add Phase button opening create modal with name+description fields, right-click context menu on phase tabs with Rename/Status cycle/Delete options, inline name editing with Enter/Escape/blur handling, delete confirmation dialog showing affected work order count with accent-warning styling; FloorClient wired with phase CRUD callbacks using optimistic updates for rename and status changes with fetchKey refetch fallback; phase selection persisted to URL query param ?phase=id for shareable bookmarkable filtered views.

**073** — Assembly Floor Agent Infrastructure — AI chat panel in Assembly Floor right panel using Anthropic Claude Haiku with streaming responses; lib/agent/floor-context.ts with FLOOR_SYSTEM_PROMPT guiding agent for work order analysis, phase planning, progress insights, and blocked item detection; buildFloorContext injecting work orders with status/priority aggregate counts and per-item details capped at 50, phase progress summaries with done/total counts, and feature tree overview capped at 30; GET/PUT /api/agent/floor for conversation persistence using agent_conversations table with module='assembly_floor'; POST /api/agent/floor/chat streaming endpoint loading work_orders, phases, and feature_nodes in parallel for context injection; FloorRightPanel rewritten from disabled placeholder to live agent chat with clickable example prompts for empty state, message history with user/assistant bubbles, streaming text display, typing indicator, auto-scroll, Shift+Enter multiline input, conversation persistence across sessions; FloorClient updated to pass projectId to agent panel.
