# Control Room (Phases 046–056)

> Blueprint management module: schema, layout, foundation blueprints, system diagrams with Mermaid, feature blueprints, rich text editor, status tracking with activity logging, agent chat.
> Key files: `components/room/`, `app/api/projects/[projectId]/blueprints/`, `lib/blueprints/`, `lib/agent/room-context.ts`, `app/api/agent/room/`

**046** — Control Room Database Schema — SQL migration 007_control_room_schema.sql creating 3 tables: blueprints with foundation/system_diagram/feature types and JSONB content for rich text and Mermaid diagrams plus draft/in_review/approved/implemented status tracking with feature_node linkage enforced by CHECK constraint requiring feature type to have node and others not to, blueprint_versions for immutable version history with content snapshots and unique blueprint_id+version_number constraint, blueprint_templates for org-scoped or system-wide templates with JSONB outline_content and partial unique indexes for org name uniqueness and one default system template per blueprint type; RLS policies using is_project_member() for blueprints, blueprint_project_member() SECURITY DEFINER helper for versions, is_org_member() for org templates with system templates visible to all; partial unique index preventing duplicate feature blueprints per node; auto-version trigger deferred to Phase 059; updated TypeScript types with convenience aliases Blueprint/BlueprintVersion/BlueprintTemplate/BlueprintType/BlueprintStatus.

**047** — Control Room Page Layout — three-panel layout with RoomClient orchestrator managing left blueprint panel 280px, center editor area, and right agent panel 300px with responsive auto-collapse below 1280px for right panel and below 768px for both panels; RoomHeader with module icon, stats bar showing foundation/diagram/feature blueprint counts with approval percentage, left and right panel toggles; RoomLeftPanel with search bar, type filter tabs All/Foundations/Diagrams/Features, collapsible blueprint sections with count badges and status badges draft/review/approved/implemented using color-coded styles, selected blueprint highlighted with accent-cyan; RoomCenterPanel with empty state prompting blueprint selection and blueprint detail view showing type breadcrumb, title, status badge, editor placeholder for Phase 049, and creation/update metadata; RoomRightPanel agent chat placeholder with Bot icon, suggested command chips for generate/review/outline, disabled input with Phase 056 notice; GET /api/projects/[projectId]/blueprints endpoint with type and search query filters and project membership validation; server component fetches blueprint type and status for initial stats.

**048** — Foundation Blueprints — creation and editing of foundation blueprints capturing project-wide technical decisions; lib/blueprints/foundation-template.ts with buildFoundationBlueprintTemplate generating 5-section TipTap JSONB template: Overview, Technology Choices, Architectural Principles, Conventions, Constraints & Limitations; DEFAULT_FOUNDATIONS array defining 5 standard foundations Backend Architecture/Frontend Architecture/Data Layer/Authentication & Security/Deployment & DevOps; POST /blueprints enhanced with foundation type requiring title and auto-filling template content; CreateBlueprintModal component with type selector cards for Foundation/System Diagram and title input with 255-char limit, Enter-to-submit, error display, loading state; RoomLeftPanel "New Blueprint" footer button enabled calling onNewBlueprint prop; RoomClient wired with createModalOpen state and handleBlueprintCreated callback triggering refetch and auto-selecting newly created blueprint.

**049** — Blueprint Rich Text Editor — TipTap-based editor for blueprint content stored as JSONB; BlueprintEditor component in components/room/blueprint-editor.tsx using @tiptap/react with StarterKit, Link, Underline, Table/TableRow/TableHeader/TableCell from @tiptap/extension-table, and Placeholder extensions; formatting toolbar with bold/italic/underline, H1-H3 headings, bullet/ordered lists, code block, blockquote, horizontal rule, table insert with row/col prompt, link, undo/redo; auto-save with 2s debounce plus blur save plus Ctrl+S manual save; unsaved changes warning dot and beforeunload guard preventing accidental navigation; save status indicator saving/saved/error; document outline sidebar extracting headings with click-to-scroll navigation; word count and reading time footer; placeholder text for empty editor; GET+PATCH /api/projects/[projectId]/blueprints/[blueprintId] endpoints with content JSONB validation and 500KB size limit; RoomCenterPanel updated from placeholder to live editor with type/title/status header bar; prose-foundry CSS extended with table/th/td styles and TipTap placeholder styles; all toolbar buttons have aria-label attributes for accessibility.

**050** — System Diagram Blueprints — Mermaid-based diagram creation and editing with split-view editor; lib/blueprints/system-diagram-template.ts with 4 diagram type templates flowchart/sequence/er/class using dark-themed Mermaid syntax, DiagramType/MermaidContent types, DIAGRAM_TYPE_OPTIONS, and buildSystemDiagramContent generating {type:'mermaid', diagram_type, code} content objects; SystemDiagramEditor component in components/room/system-diagram-editor.tsx with split-view layout: left code editor with line numbers, monospace font, Tab/Shift+Tab indent support, and right live Mermaid preview with dynamic import and dark theme configuration; zoom/pan controls with zoom in/out/reset buttons and click-drag panning with transform translation; resizable split pane via drag handle with 20-80% range; fullscreen preview toggle; SVG and PNG export via Blob download and canvas conversion; auto-save with 2s debounce plus Ctrl+S manual save; diagram type switching with confirmation dialog when code differs from template; 500ms debounced render with error display; RoomCenterPanel updated to route system_diagram blueprints to SystemDiagramEditor instead of TipTap BlueprintEditor; CreateBlueprintModal enhanced with diagram type selector grid shown when system_diagram type selected using accent-purple highlighting; POST /blueprints enhanced with system_diagram type requiring title and diagram_type, auto-filling Mermaid template content via buildSystemDiagramContent; mermaid npm dependency added.

**051** — Feature Blueprints — feature blueprint creation and editing with 1:1 linking to Pattern Shop feature nodes; POST /api/projects/[projectId]/blueprints with blueprint_type='feature' auto-populating title from feature_node.title, generating 7-section TipTap JSONB template (Solution Overview, API Endpoints, UI Components & Behavior, Data Model Changes, Business Logic, Testing Requirements, Dependencies), and enforcing unique constraint returning 409 if duplicate; GET /api/projects/[projectId]/blueprints/for-feature/[featureNodeId] for blueprint-by-feature lookup; DELETE /api/projects/[projectId]/blueprints/[blueprintId] for blueprint deletion; PATCH enhanced to restrict title updates on feature blueprints since titles sync from feature node; RoomLeftPanel enhanced with feature tree display mirroring Pattern Shop structure showing blueprint status badges Draft/Review/Approved/Impl on nodes with blueprints and hover "Create" buttons on nodes without; FeatureNodeItem recursive tree component with expand/collapse, depth-based indentation, and search filtering including descendant matching; RoomCenterPanel enhanced with status dropdown for changing blueprint status and "View Feature" link navigating to Pattern Shop for feature blueprints; RoomClient enhanced with parallel fetch of blueprints and feature tree, handleCreateFeatureBlueprint with optimistic local state update and auto-select, handleStatusChange with optimistic update and fetchKey refetch fallback; lib/blueprints/feature-template.ts with buildFeatureBlueprintTemplate generating TipTap-compatible JSONContent.

**054** — Blueprint Status Tracking — blueprint lifecycle workflow with activity logging; SQL migration 014_blueprint_activities_schema.sql creating blueprint_activities table with id/blueprint_id/user_id/action/action_details/created_at fields, CHECK constraint for action values created/status_changed/content_updated/reviewed/commented, RLS via blueprint_activity_project_member() SECURITY DEFINER helper, composite index on blueprint_id+created_at DESC; activity logging from API routes: POST /blueprints logs 'created' on blueprint creation, PATCH /blueprints/[id] logs 'status_changed' with from/to details and 'content_updated' on content saves, all fire-and-forget; GET /blueprints/[id]/activities endpoint with pagination, profile enrichment, reverse chronological order; GET /blueprints/stats endpoint with by_status counts, total, avg_age_days, pending_review, ready_for_implementation metrics; BlueprintActivityTimeline collapsible component in center panel showing activity count badge, expandable timeline with action-specific icons and color coding success/warning/cyan/purple, user display_name, formatted descriptions, relative timestamps with hover tooltips; RoomCenterPanel enhanced with status change confirmation dialog for Approved/Implemented final states using Dialog component, status dropdown with color dots per status; TypeScript types added for blueprint_activities table with BlueprintActivity convenience alias.

**053** — Blueprint Templates — system and organization-level blueprint templates for standardized blueprint creation; lib/blueprints/system-templates.ts with TemplateOutline/TemplateSection interfaces, 3 system template definitions (Foundation with 5 sections, System Diagram with 2 sections, Feature with 7 sections), SYSTEM_TEMPLATES array, and outlineToTipTapContent converter generating heading+paragraph pairs from outline sections; SQL migration 018_seed_system_templates.sql seeding 3 system templates with org_id=NULL and is_default=true using outline_content JSONB matching runtime definitions; GET /api/projects/[projectId]/blueprint-templates returning system + org templates with type filter, fallback to hardcoded definitions if no DB templates; POST endpoint converting outline_content to TipTap JSONContent; GET/POST /api/orgs/[orgId]/blueprint-templates for listing and creating org templates with admin-only enforcement, name uniqueness per org+type, section validation (title required, at least 1 section), and is_default handling clearing previous defaults; PATCH/DELETE /api/orgs/[orgId]/blueprint-templates/[templateId] with system template protection (cannot edit/delete), org ownership verification, and cascading default management; CreateBlueprintModal enhanced with template picker fetching templates on open, auto-selecting default template per type, system templates with Lock icon and org templates with FileText icon, collapsible section preview showing description, sections with required badges and help text; template_content override added to POST /blueprints for foundation and feature types; TemplatesTab component added to OrgConsoleClient as 5th tab with templates grouped by blueprint type in collapsible glass-panel sections, system templates shown read-only with lock icon, org templates with edit/delete/set-default hover actions, create/edit modal with dynamic section editor (add/remove sections, title/placeholder/help_text/required per section), delete confirmation dialog, and template preview modal.

**052** — Feature-Blueprint Linking — bidirectional linking between Pattern Shop feature nodes and Control Room blueprints with visual indicators; GET /api/projects/[projectId]/blueprints/missing endpoint returning feature nodes without linked blueprints by comparing feature_nodes against blueprints table; BlueprintStatusIcon component displaying color-coded status icons on feature tree nodes: green check for approved/implemented, yellow filled circle for in_review, gray circle for draft, red X for missing; FeatureTree enhanced with fetchBlueprintStatuses fetching all feature blueprints to build featureNodeId→status map, passed as blueprintStatusMap prop to TreeNodeRow; TreeNodeRow displays BlueprintStatusIcon after title for epic/feature/sub_feature nodes (excluding tasks); NodeContextMenu extended with "View Blueprint" (opens Control Room in new tab) or "Create Blueprint" (creates feature blueprint via POST /blueprints) option based on whether blueprint exists; BlueprintStatusCard component shown above FeatureRequirementEditor displaying blueprint status badge with update timestamp and "View Blueprint" link to Control Room, or "Create Blueprint" CTA if no blueprint exists; ShopClient handles blueprint actions from context menu with navigation to Control Room URL pattern /org/[orgSlug]/project/[projectId]/room?blueprint=[id]; orgSlug threaded through ShopClient→ShopCenterPanel→FeatureRequirementEditor for cross-module navigation links.

**056** — Control Room Agent Infrastructure — AI chat panel in Control Room right panel using Anthropic Claude Haiku with streaming responses; lib/agent/room-context.ts with ROOM_SYSTEM_PROMPT guiding agent for blueprint generation, review, architecture assistance, gap detection, and consistency checking; buildRoomContext injecting current blueprint content with full text, all foundation blueprints and system diagrams with content previews up to 2000 chars each, feature blueprint list capped at 20; extractText utility for TipTap JSONB content traversal; 15KB total prompt cap with truncation; GET/PUT /api/agent/room for conversation persistence using agent_conversations table with module='control_room'; POST /api/agent/room/chat streaming endpoint loading all project blueprints in parallel for full context injection with currentBlueprintId for focused context; Claude Haiku with 2000 max_tokens; RoomRightPanel rewritten from disabled placeholder to live agent chat with clickable example prompts for empty state including Generate/Review/Outline/Endpoints suggestions, message history with user/assistant bubbles, streaming text display, typing indicator with animated dots, auto-scroll, Shift+Enter multiline input, conversation persistence across sessions; RoomClient updated to pass projectId and selectedBlueprintId to agent panel for context-aware responses.
