# Pattern Shop (Phases 026–037)

> Feature decomposition module: schema, layout, feature tree, node CRUD, drag-and-drop, status tracking, requirements documents, rich text editor, agent chat.
> Key files: `components/shop/`, `app/api/projects/[projectId]/feature-nodes/`, `app/api/projects/[projectId]/feature-tree/`, `app/api/projects/[projectId]/requirements-documents/`, `app/api/projects/[projectId]/product-overview/`, `app/api/agent/shop/`, `lib/shop/`, `lib/agent/shop-context.ts`

**026** — Pattern Shop Database Schema — SQL migration 004_pattern_shop_schema.sql creating 3 tables: feature_nodes with hierarchical tree structure supporting epic/feature/sub_feature/task levels and not_started/in_progress/complete/blocked status tracking with position ordering and soft-delete via deleted_at, requirements_documents with product_overview/feature_requirement/technical_requirement doc types linking to feature nodes, requirement_versions for document version history with version numbers and change summaries; RLS policies on all 3 tables using is_project_member(); new requirement_doc_project_member() SECURITY DEFINER function for indirect project membership checks; indexes on project_id, parent_id, feature_node_id, requirement_doc_id; auto-update triggers on feature_nodes.updated_at and requirements_documents.updated_at; updated TypeScript types with full Row/Insert/Update definitions and convenience aliases FeatureNode/RequirementsDocument/RequirementVersion/FeatureLevel/FeatureStatus/RequirementDocType.

**027** — Pattern Shop Page Layout — three-panel layout with left panel 280px collapsible feature tree containing search input, pinned Product Overview, feature tree placeholder, and collapsed Technical Requirements section; center panel flex-grow document editor with empty state prompting feature selection and toolbar placeholder with word count; right panel 360px collapsible Pattern Shop Agent with chat UI placeholder disabled until Phase 037; shop header with module icon and stats bar showing epic/feature/sub-feature/task counts with completion percentage sourced from feature_nodes table; getting-started banner for empty projects with Create Epic and Upload Brief CTAs dismissible; responsive auto-collapse right panel below 1400px and both panels below 960px; server component fetches feature_nodes stats from Phase 026 schema; independent scrolling per panel with smooth 200ms collapse transitions.

**028** — Product Overview Document — GET/PUT /api/projects/[projectId]/product-overview endpoint with lazy initialization creating product_overview requirements_document on first access if missing; PRODUCT_OVERVIEW_TEMPLATE constant in lib/shop/product-overview-template.ts with 5-section HTML template: Business Context, Problem Statement, Target Users, Success Metrics, Key Decisions with italic guidance placeholders; ProductOverviewEditor component in components/shop/product-overview-editor.tsx with contentEditable div rendering HTML, 2-second debounced auto-save via saveTimerRef, save status indicator showing Saving.../Saved with CheckCircle2 icon, word count in toolbar stripped from HTML tags, loading spinner and error retry states; prose-foundry CSS class in globals.css styling h1/h2/p/em/ul/ol/a/strong for dark theme with accent-cyan h2 headings and border-bottom separators; ShopLeftPanel Product Overview button made interactive with accent-cyan/10 selected background using 'product-overview' sentinel value in selectedNodeId; ShopCenterPanel updated to route 'product-overview' to ProductOverviewEditor and feature node IDs to future requirements placeholder; auto-creation of product overview on project creation in POST /api/projects inserting requirements_documents row with template content.

**029** — Feature Tree Component — GET /api/projects/[projectId]/feature-tree endpoint fetching all non-deleted feature_nodes for a project with membership validation and server-side tree building via buildTree function grouping by parent_id with recursive position sorting; FeatureTree component in components/shop/feature-tree.tsx managing fetch/loading/error/empty states with expandedIds Set for expand/collapse state tracking; TreeNodeRow recursive memo component in components/shop/tree-node-row.tsx rendering individual nodes with level icons FolderOpen/Puzzle/Layers/CheckCircle2 mapped to epic/feature/sub_feature/task, status color dots using accent-cyan/accent-success/accent-error/text-tertiary for in_progress/complete/blocked/not_started, ChevronDown/ChevronRight expand toggle for nodes with children, depth-based indentation at 16px per level, selected state with accent-cyan/10 background and cyan left border and bold text, hover state with bg-tertiary; ShopLeftPanel updated from placeholder empty state to live FeatureTree with projectId/selectedNodeId/onSelectNode props; ShopClient wired with setSelectedNodeId callback passed through ShopLeftPanel to FeatureTree completing the node selection pipeline to center panel; Trees icon empty state when no feature nodes exist.

**030** — Add Nodes to Feature Tree — POST /api/projects/[projectId]/feature-nodes endpoint creating feature nodes with auto-calculated level based on parent hierarchy epic->feature->sub_feature->task, auto-positioned via MAX(sibling position)+1, task nodes blocked from having children returning 400 error; PATCH /api/projects/[projectId]/feature-nodes/[nodeId] for inline title updates; DELETE for soft-delete setting deleted_at timestamp; NodeContextMenu custom context menu component in components/shop/node-context-menu.tsx with Add Child and Add Sibling actions plus disabled Edit/Change Level/Delete placeholders for Phase 031, fixed positioning, click-outside and Escape to dismiss; TreeNodeRow updated with Plus button appearing on hover via opacity-0 group-hover:opacity-100 for non-task nodes, right-click triggering context menu via onContextMenu handler, inline title editing with autofocused input replacing title text, Enter to save, Escape to cancel deleting empty untitled nodes, blur auto-saves; FeatureTree updated with editingNodeId state tracking which node is being edited, createNode function POSTing to API then refetching tree and entering edit mode, handleAddChild validating parent can have children, handleAddSibling creating at parent level, handleAddEpic for root-level creation, auto-expanding parent when child added, "Add Epic" button in empty state and at bottom of tree; context menu state with position/nodeId/nodeLevel/parentId.

**031** — Edit & Delete Tree Nodes — enhanced PATCH /api/projects/[projectId]/feature-nodes/[nodeId] with level change support validating single-step transitions via LEVEL_ORDER map, blocking task demotion when node has children, recursively adjusting children levels via adjustChildrenLevels helper; enhanced DELETE endpoint accepting deleteOption in JSON body: delete_only default, delete_subtree with recursive softDeleteSubtree, reparent_children moving children to deleted node's parent; POST /api/projects/[projectId]/feature-nodes/[nodeId]/restore for undo restoring deleted_at to null; DeleteNodeDialog component with 3 radio options delete_only/delete_subtree/reparent_children showing child count and accent-error danger styling; ChangeLevelDialog with 4 level options FolderOpen/Puzzle/Layers/CheckCircle2 icons validating single-step transitions and disabling task when node has children; NodeContextMenu enabled Edit/Delete/Change Level buttons with callbacks; FeatureTree wired with deleteDialog and changeLevelDialog state, findNode and countAllChildren helpers, undo toast with 10-second window calling restore endpoint; TreeNodeRow updated with onDoubleClick prop for inline edit via double-click on title.

**032** — Feature Tree Drag-and-Drop — PUT /api/projects/[projectId]/feature-nodes/[nodeId]/move endpoint accepting parentId and position with level hierarchy validation via VALID_PARENT_LEVELS map, circular reference prevention via checkIsDescendant, sibling renumbering via renumberSiblings; @dnd-kit/core integration with DndContext wrapping FeatureTree, PointerSensor with 5px activation constraint, DragOverlay with ghost card; TreeNodeRow enhanced with useDraggable for GripVertical drag handle, three useDroppable zones per node for before/on/after drop targets; visual feedback with green ring for valid drops, red for invalid, opacity-30 on dragged node; optimistic tree updates via applyMoveToTree with API failure revert; undo toast with 5-second window calling move API with original position.

**033** — Feature Requirements Document — buildFrdTemplate function in lib/shop/frd-template.ts generating 6-section HTML template: Overview, User Story, Requirements, Acceptance Criteria, Out of Scope, Dependencies with italic guidance placeholders; GET/POST /api/projects/[projectId]/requirements-documents with featureNodeId and docType query filters using DocType casting for typed Supabase queries, POST creating FRD with auto-template from feature node title and 409 Conflict if FRD already exists for that node; GET/PUT /api/projects/[projectId]/requirements-documents/[docId] for individual document retrieval and title/content updates with project membership validation; FeatureRequirementEditor component with auto-creation logic fetching FRD list by featureNodeId and auto-POSTing to create if none found with 409 race-condition re-fetch handling, contentEditable div with 2-second debounced auto-save, save status indicator with Save icon pulse and CheckCircle2 Saved confirmation, word count in toolbar stripped from HTML tags; ShopCenterPanel updated to route feature node selections to FeatureRequirementEditor with key={selectedNodeId} forcing remount on node change to avoid stale contentEditable state.

**034** — Requirements Document Editor — TipTap rich text editor replacing basic contentEditable divs; RequirementsEditor reusable component in components/shop/requirements-editor.tsx with @tiptap/react @tiptap/starter-kit @tiptap/extension-link @tiptap/extension-underline; formatting toolbar with bold/italic/underline, H1/H2/H3 headings, bullet/ordered lists, code block, blockquote, link insert/edit, undo/redo buttons with active state highlighting; auto-save with 2-second debounce after typing stops plus save on blur plus Ctrl+S manual save; save status indicator showing Saving.../Saved/Failed to save with icon; live word count and reading time in footer bar; toggleable document outline sidebar extracting H1-H3 headings from TipTap editor state with click-to-scroll navigation; ProductOverviewEditor and FeatureRequirementEditor refactored to data-fetching wrappers delegating rendering to RequirementsEditor; extended prose-foundry CSS with h3 styling, pre/code blocks with monospace font and bg-primary background, blockquote with cyan left border, underline, hr, list-style-type for ul/ol; content length validation max 50000 chars on PUT requirements-documents API route.

**035** — Feature Tree Status Tracking — PUT /api/projects/[projectId]/feature-nodes/[nodeId]/status endpoint updating node status with automatic parent cascade recalculating ancestor statuses up the chain using calculateParentStatus logic: all children complete->parent complete, any blocked->parent blocked, any in_progress/complete->parent in_progress, else not_started; GET /api/projects/[projectId]/feature-nodes/[nodeId]/progress endpoint returning child status breakdown with totalChildren/completeChildren/inProgressChildren/blockedChildren/notStartedChildren/completionPercent/statusBreakdown; clickable status dot on each TreeNodeRow opening inline dropdown with 4 status options not_started/in_progress/complete/blocked using Circle icons with filled/outline states, click-outside dismiss, z-50 positioning; progress bar on expanded parent nodes showing gradient bar from accent-success to accent-cyan with hover tooltip showing "X of Y complete (Z%)"; optimistic UI updates with server refetch for cascade sync; FeatureTree handleStatusChange callback with optimistic local tree update then PUT API call with refetch to pick up cascaded parent changes.

**036** — Feature Tree Search & Filter — TreeSearchFilter component in components/shop/tree-search-filter.tsx with search input, clear button, result counter, collapsible status filter checkboxes (not_started/in_progress/complete/blocked) with per-status counts, collapsible level filter checkboxes (epic/feature/sub_feature/task) with per-level counts, custom styled checkboxes with accent-cyan theme, All/None quick-select buttons, Clear All Filters button; client-side search logic in FeatureTree computing matchingNodeIds via case-insensitive title+description match with status and level AND-filtering, displayNodeIds including all ancestors for tree context preservation; match highlighting with accent-warning/30 background mark tags; non-matching ancestors shown at opacity-60; auto-expand ancestors of matching nodes during search; debounced filter info callback reporting matchCount/statusCounts/levelCounts to parent; ShopLeftPanel manages search/filter state passing props to both TreeSearchFilter and FeatureTree; TreeNodeRow enhanced with isSearchActive/matchingNodeIds/displayNodeIds/searchQuery props for per-node visibility filtering and highlight rendering; Cmd/Ctrl+F keyboard shortcut to focus search, Escape to clear; GET /api/projects/[projectId]/feature-nodes/search endpoint with q/statuses/levels query params returning matchingNodeIds/displayNodeIds/totalMatches/statusCounts/levelCounts.

**037** — Pattern Shop Agent Infrastructure — AI chat panel in Pattern Shop right panel using Anthropic Claude Haiku with streaming responses; lib/agent/shop-context.ts with SHOP_SYSTEM_PROMPT guiding agent for feature decomposition, requirements review, and gap detection; buildShopContext injecting feature tree as formatted hierarchical text, product overview content truncated to 3000 chars, and currently selected FRD; GET/PUT /api/agent/shop for conversation persistence using agent_conversations table with module='pattern_shop'; POST /api/agent/shop/chat streaming endpoint loading feature_nodes, product_overview requirements_document, and selected node's FRD for full context injection; ShopRightPanel rewritten from disabled placeholder to live agent chat with message history, user/assistant bubbles with avatar icons, streaming text display, typing indicator with animated dots, auto-scroll, Enter-to-send textarea with auto-resize, conversation persistence across sessions; ShopClient updated to pass projectId and selectedNodeId to agent panel for context-aware responses.
