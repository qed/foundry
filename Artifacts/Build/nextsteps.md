# Helix Foundry — Prompt Template (Living Document)

> **Purpose**: Master template used by the Conductor session to generate phase prompts.
> **Updated by**: The Conductor session after each wave merges.
> **Last updated**: 2026-02-22 (Phase 030 complete)

---

## Section 0: Session Title

> Include at the very top of every build prompt.

```
Title: Build Helix Foundry Phase XXX
```

Where XXX is the phase number (e.g., 017, 026, 113). This sets the Claude Code session title so you can identify it.

---

## Section 1: Phase History Paragraph

> Copy this into every phase prompt. After each wave completes, the Conductor appends new phase descriptions.

Phases 001 (Next.js setup), 002 (Supabase database schema — organizations, org_members, projects, project_members tables with RLS policies, is_project_member() and is_org_member() SECURITY DEFINER helpers, indexes, auto-update triggers), 003 (Supabase auth — login, signup, password reset, AuthProvider context), 004 (Auth middleware — proxy.ts route protection, cached server auth helpers requireAuth/requireAuthWithProfile, logout/status/profile API routes, useRequireAuth hook, redirectTo wiring), 005 (Multi-tenancy — URL-based org/project routing, OrgProvider/ProjectProvider/CurrentUserProvider contexts, org/project layouts with membership validation, org selector + org home + project dashboard pages, 5 module placeholder pages, org/project creation API routes + forms, org-validation helpers, useOrgData/useProjectData hooks, custom module icons), 006 (Core UI Shell — collapsible sidebar with Dashboard + 5 module nav items using Lucide icons and cyan active highlights, header bar with breadcrumb navigation and user avatar dropdown, mobile bottom tab bar with custom colorful module icons, AppLayout shell combining sidebar/header/mobile-nav with responsive behavior, sidebar collapse desktop-only, simplified module pages for shell context, focus-visible styles), 007 (Global UI Components — 12 reusable components in components/ui/: Button with 5 variants + 3 sizes + loading state via class-variance-authority, Input/Textarea/Select with labels + error + helper text, Card with composable Header/Title/Body/Footer, Badge with 7 variants including purple, Dialog modal with overlay close + Escape key + scroll lock, Spinner in 3 sizes, Avatar with gradient initials fallback, Toast + ToastContainer with 4 types and auto-dismiss via useToast hook, EmptyState with icon/title/description/action, ToastProvider wired into root layout, component showcase page at /components), 008 (Registration & Onboarding — onboarding router at /onboarding that checks org membership and redirects, org-choice page with Create/Join cards, create-org page with slug preview calling /api/orgs, join-org page with base64 invite code calling /api/orgs/join, create-project page calling /api/projects then redirecting to project dashboard, /api/orgs/join endpoint using createServiceClient to bypass RLS, upgraded /org page from silent redirect into org selector hub showing all user orgs with role badges plus create/join action cards, replaced home page email display with cyan Enter button linking to /org), 009 (Roles & Permissions — RBAC permission system with typed org permissions admin/member and project permissions leader/developer, permission definitions with role-to-permission mappings, pure checker functions canOrgPermission/canProjectPermission/canAll/canAny, server-side permission guards requireOrgPermission/requireProjectPermission that throw ForbiddenError, client-side usePermission hook, example permission-aware components create-requirement-button/requirement-list-item/module-nav-item, example permission-protected API route /api/projects/[projectId]/settings, reusable context-aware UserMenu component with role badges, TopBar component for non-project pages, refactored Header to use shared UserMenu, added TopBar with avatar to all authenticated pages including home/org-selector/org-home/onboarding, useOptionalOrg and useOptionalProject hooks for context-aware rendering outside providers), 010 (Navigation & Module Switching — reusable Breadcrumb component refactored from header, Project Switcher dropdown in sidebar for switching between projects, Org Switcher dropdown in sidebar for switching between organizations, permission-aware sidebar module links showing disabled/restricted state, keyboard shortcuts hook with Cmd/Ctrl+1-5 module jumping wired into AppLayout, keyboard hint display in sidebar footer, GET /api/orgs/list endpoint returning user orgs with roles, GET /api/orgs/[orgId]/projects endpoint returning org projects with membership validation), 011 (Hall Database Schema — SQL migration 003_hall_schema.sql creating 5 tables: ideas with status tracking raw/developing/mature/promoted/archived + project scoping + audit fields + promoted_to_seed_id nullable UUID, tags with project-scoped custom colors + unique name constraint, idea_tags junction table, idea_connections for related/duplicates/extends relationships, agent_conversations with JSONB messages; RLS policies on all 5 tables using existing is_project_member() SECURITY DEFINER helper; new idea_project_member() SECURITY DEFINER function for indirect project membership checks on junction tables; 10 indexes; auto-update triggers on ideas.updated_at and agent_conversations.updated_at; updated TypeScript types with full Row/Insert/Update definitions and convenience aliases Idea/Tag/IdeaTag/IdeaConnection/AgentConversation/IdeaStatus), 012 (Hall Page Layout & UI — replaced Hall placeholder with full interactive page: HallClient orchestrator manages URL state for view/search/status/sort via useSearchParams + useRouter.replace, HallHeader with title/icon/subtitle/search input/New Idea button/Grid-List view toggle, HallEmptyState with lightbulb icon and CTA, IdeaCard with status badge/title-body preview/colored tag chips/creator avatar/relative timestamp, IdeaGrid with responsive 3/2/1 column layout and skeleton loading, IdeaList with select-all checkbox/column headers/compact rows/responsive column hiding, FilterBar with status dropdown/sort dropdown/active filter chips/clear all, ViewToggle with Grid/List icons, mobile FAB for New Idea above bottom nav, server component data fetching enriching ideas with tags and creator profiles, loading.tsx skeleton, shared types IdeaWithDetails/STATUS_CONFIG/STATUS_OPTIONS/SORT_OPTIONS, timeAgo utility in lib/utils.ts), 013 (Create Idea / Note Capture — IdeaCreateModal with title input (required, 200 char limit with live counter, autofocus), description textarea (optional, 3000 char limit with live counter, resizable), tag selection with search/filter existing project tags plus inline tag creation with custom color picker, client-side validation with error messages, submit button disabled until title has content with loading spinner, cancel with dirty-form discard confirmation, overlay click and Escape key dismiss, desktop centered 600px modal / mobile full-screen, success/error toasts via ToastProvider, POST /api/hall/ideas endpoint with server-side validation + project membership check + tag verification + new tag creation + full idea+tags+creator response, GET /api/hall/tags endpoint for fetching project tags, HallClient wired to router.refresh() on idea creation, useOptionalAuth hook fix for UserMenu HMR resilience), 014 (Idea List View — GET /api/hall/ideas endpoint with pagination (limit/offset), sorting (newest/oldest/updated/A-Z/Z-A), search (title+body ilike), status filtering, project membership validation, batch tag+profile enrichment, total count + hasMore flag; LoadMoreTrigger component with IntersectionObserver for auto-loading next page on scroll; NoResultsState component with SearchX icon and clear filters button; HallClient rewritten from client-side-only filtering to hybrid server+client pagination with initial 12 ideas from server component then API-based infinite scroll on scroll/filter/sort changes with 300ms search debounce and AbortController race condition handling; Hall page server component fetches only first 12 ideas + total count; alphabetical sort options A-Z and Z-A; loading states with opacity dimming + spinner during refetch, spinner during infinite scroll, "All N ideas loaded" end-of-list message), 015 (Hall Search & Filter — tag filter dropdown in FilterBar with multi-select checkboxes, search-within-tags input, Select all / Deselect all controls, AND-logic tag filtering; search clear (X) button in HallHeader search input; active filter chip bar below filter controls with removable chips for search term, status, and each selected tag with color dots; Clear all button resets search/status/tags/sort; filtered result count "N ideas found"; tag selections stored in URL as ?tags=uuid1,uuid2 for shareable bookmarkable filter states; GET /api/hall/ideas updated with tags param and server-side AND-logic filtering via idea_tags junction table; project tags fetched server-side and passed as initialTags to HallClient; all filters composable with URL state management), 016 (Idea Detail Slide-Over — slide-over panel from right edge on idea card click with 300ms animation, 600px desktop / 500px tablet / full-width mobile, overlay click-to-close + Escape key + body scroll lock; full idea display with status badge, creator avatar/name/timestamps, full body text, colored clickable tag pills that filter Hall on click, Related Ideas section with connection type badges and click-to-navigate between connected ideas, Idea Info panel with metadata grid; action buttons Edit/Archive/Promote as UI placeholders for future phases; Archive confirmation dialog; loading spinner + error retry state; GET /api/hall/ideas/[ideaId] endpoint with tags + creator + membership validation; GET /api/hall/ideas/[ideaId]/connections endpoint with bidirectional connection fetching + enriched details; onIdeaClick wired into IdeaGrid and IdeaList; HallClient manages selectedIdeaId state), 017 (Edit & Delete Ideas — PUT /api/hall/ideas/[ideaId] for inline editing with field-level updates supporting title/body/status changes, DELETE /api/hall/ideas/[ideaId] for soft-delete setting deleted_at timestamp, POST /api/hall/ideas/[ideaId]/undelete for undo within toast window restoring deleted_at to null; idea-edit-form.tsx with auto-save on blur and debounced title editing with 500ms delay; idea-action-buttons.tsx wired with Edit pencil icon and Archive trash icon actions; idea-detail-slide-over.tsx with edit mode toggle switching between view and inline edit; hall-client.tsx with optimistic update/archive handlers providing instant UI feedback and undo toast with 5-second window; toast system enhanced with action button support enabling undo capability on destructive operations), 026 (Pattern Shop Database Schema — SQL migration 004_pattern_shop_schema.sql creating 3 tables: feature_nodes with hierarchical tree structure supporting epic/feature/sub_feature/task levels and not_started/in_progress/complete/blocked status tracking with position ordering and soft-delete via deleted_at, requirements_documents with product_overview/feature_requirement/technical_requirement doc types linking to feature nodes, requirement_versions for document version history with version numbers and change summaries; RLS policies on all 3 tables using is_project_member(); new requirement_doc_project_member() SECURITY DEFINER function for indirect project membership checks; indexes on project_id, parent_id, feature_node_id, requirement_doc_id; auto-update triggers on feature_nodes.updated_at and requirements_documents.updated_at; updated TypeScript types with full Row/Insert/Update definitions and convenience aliases FeatureNode/RequirementsDocument/RequirementVersion/FeatureLevel/FeatureStatus/RequirementDocType), and 018 (Tagging & Tag Management — tag management page at /hall/tags with search, sort by name/usage/newest, responsive glass-panel card grid; create tag modal with name input max 30 chars unique-per-project validation, 8-color preset palette plus custom hex input with live tag preview; edit tag modal with pre-populated values and in-use warning showing affected idea count; delete tag confirmation with usage count display, option to merge into another tag reassigning all ideas or remove from all ideas; POST /api/hall/tags for standalone tag creation with duplicate checking, PUT /api/hall/tags/[tagId] for name and color updates, DELETE /api/hall/tags/[tagId] with cascade removal from idea_tags, POST /api/hall/tags/[tagId]/merge to reassign ideas to target tag then delete source; GET /api/hall/tags enhanced with includeUsage=true parameter for usage counts via idea_tags aggregation; Manage Tags link added to Hall header navigation; idea create modal autocomplete enhanced to show per-tag usage counts; ColorPicker component with preset swatches and hex input; EmptyState with Tags icon and create CTA), 027 (Pattern Shop Page Layout — three-panel layout with left panel 280px collapsible feature tree containing search input, pinned Product Overview, feature tree placeholder, and collapsed Technical Requirements section; center panel flex-grow document editor with empty state prompting feature selection and toolbar placeholder with word count; right panel 360px collapsible Pattern Shop Agent with chat UI placeholder disabled until Phase 037; shop header with module icon and stats bar showing epic/feature/sub-feature/task counts with completion percentage sourced from feature_nodes table; getting-started banner for empty projects with Create Epic and Upload Brief CTAs dismissible; responsive auto-collapse right panel below 1400px and both panels below 960px; server component fetches feature_nodes stats from Phase 026 schema; independent scrolling per panel with smooth 200ms collapse transitions), 061 (Assembly Floor Database Schema — SQL migration 005_assembly_floor_schema.sql creating 3 tables: phases with project-scoped name uniqueness and planned/active/completed status tracking with position ordering, work_orders with comprehensive fields including title/description/description_json/acceptance_criteria/implementation_plan/implementation_plan_json plus backlog/ready/in_progress/in_review/done status and critical/high/medium/low priority with feature_node linkage and assignee tracking, work_order_activity for immutable audit trail with action and JSONB details; RLS policies on all 3 tables using is_project_member() for direct project tables; new work_order_project_member() SECURITY DEFINER function for indirect project membership checks on activity table; activity table intentionally has no UPDATE or DELETE policies to enforce immutability; 11 indexes including composite project_id+phase_id; CHECK constraints for status and priority enums; auto-update triggers on phases.updated_at and work_orders.updated_at; blueprint_id FK deferred to Phase 046; updated TypeScript types with full Row/Insert/Update definitions and convenience aliases Phase/WorkOrder/WorkOrderActivity/WorkOrderStatus/WorkOrderPriority/PhaseStatus), and 081 (Insights Lab Database Schema — SQL migration 006_insights_lab_schema.sql creating 2 tables: app_keys for project-scoped API keys with active/revoked status and unique key_value constraint for external feedback collection authentication, feedback_submissions with content text and category classification bug/feature_request/ux_issue/performance/other/uncategorized plus new/triaged/converted/archived status tracking and optional AI priority score 0-100, text array tags, JSONB metadata for browser/device/page_url/user_agent, conversion tracking via converted_to_work_order_id FK to work_orders and converted_to_feature_id FK to feature_nodes, nullable submitter_email and submitter_name; RLS policies using is_project_member() for tenant isolation plus special insert policy allowing external submissions with valid app keys via is_active_app_key() SECURITY DEFINER helper; 7 indexes including composite project+created_at DESC for inbox listing, project+status for filtering, project+score DESC NULLS LAST for prioritization; auto-update trigger on feedback_submissions.updated_at; updated TypeScript types with full Row/Insert/Update definitions and convenience aliases AppKey/FeedbackSubmission/AppKeyStatus/FeedbackCategory/FeedbackStatus), and 046 (Control Room Database Schema — SQL migration 007_control_room_schema.sql creating 3 tables: blueprints with foundation/system_diagram/feature types and JSONB content for rich text and Mermaid diagrams plus draft/in_review/approved/implemented status tracking with feature_node linkage enforced by CHECK constraint requiring feature type to have node and others not to, blueprint_versions for immutable version history with content snapshots and unique blueprint_id+version_number constraint, blueprint_templates for org-scoped or system-wide templates with JSONB outline_content and partial unique indexes for org name uniqueness and one default system template per blueprint type; RLS policies using is_project_member() for blueprints, blueprint_project_member() SECURITY DEFINER helper for versions, is_org_member() for org templates with system templates visible to all; partial unique index preventing duplicate feature blueprints per node; auto-version trigger deferred to Phase 059; updated TypeScript types with convenience aliases Blueprint/BlueprintVersion/BlueprintTemplate/BlueprintType/BlueprintStatus), and 096 (Artifacts Database & Storage Schema — SQL migration 008_artifacts_schema.sql creating 2 tables: artifact_folders with hierarchical self-referencing parent_folder_id for folder organization with unique name constraint per project+parent and CASCADE delete for nested cleanup, artifacts for file metadata with project scoping and folder placement via folder_id FK to artifact_folders plus file_type/file_size/storage_path fields with unique storage_path constraint and optional content_text for future full-text search and uploaded_by tracking; RLS policies using is_project_member() for tenant isolation; artifact_project_member() SECURITY DEFINER helper for future entity linking; 7 indexes for project/folder/uploader/date/type queries; auto-update triggers on updated_at; updated TypeScript types with convenience aliases ArtifactFolder/Artifact), and 105 (Comments System Foundation Schema — SQL migration 009_comments_schema.sql creating polymorphic comments table supporting all entity types idea/feature_node/requirement_doc/blueprint/work_order/feedback via entity_type CHECK constraint and entity_id UUID reference; threaded replies via self-referencing parent_comment_id with CASCADE delete; soft delete via deleted_at timestamp; resolution tracking via is_resolved boolean on root comments; anchored comments via anchor_data JSONB for inline text selection references; RLS policies using is_project_member() for tenant isolation; comment_project_member() SECURITY DEFINER helper; 6 indexes including composite project+entity_type+entity_id; auto-update trigger on updated_at; updated TypeScript types with convenience aliases Comment/CommentEntityType), and 109 (Knowledge Graph Schema — SQL migration 010_knowledge_graph_schema.sql creating entity_connections table for cross-module relationship tracking between ideas/features/blueprints/work_orders/feedback/artifacts with 7 connection types references/depends_on/relates_to/implements/derived_from/conflicts_with/complements; unique constraint preventing duplicate connections; is_auto_detected boolean with JSONB metadata for confidence scores and evidence; bidirectional_connections view mirroring symmetric types relates_to/conflicts_with/complements for both-direction queries; filtered index on manual connections for common lookup patterns; RLS using is_project_member(); 6 indexes plus filtered manual lookup; updated TypeScript types with convenience aliases EntityConnection/EntityConnectionType/GraphEntityType), and 113 (Organization Console — full admin settings UI at /org/[slug]/settings accessible only to org admins; SQL migration 011_org_console_schema.sql adding description and avatar_url columns to organizations; PATCH /api/orgs/[orgId] for updating org name/description/avatar, DELETE /api/orgs/[orgId] for founding-admin-only org deletion with cascading cleanup; GET /api/orgs/[orgId]/members for member list with profile enrichment; PATCH /api/orgs/[orgId]/members/[memberId] for role changes with last-admin and self-modification guards, DELETE for member removal; four-tab console: General Settings with name/description editing and slug display, Members tab with search/role filter/role change dropdown/remove with confirmation dialog, Projects tab with project list and open links, Danger Zone with type-slug-to-confirm deletion dialog; server component with admin role check redirecting non-admins; glass-panel styling with accent-error border on danger zone; updated TypeScript types adding description and avatar_url to organizations), and 117 (Real-Time Presence — Supabase Realtime presence tracking per project channel; usePresence hook subscribing to project:{id}:presence channel with automatic join/leave/sync events and module tracking; useCurrentModule hook deriving active module from URL pathname; presence data includes user_id, display_name, avatar_url, current_module; OnlineIndicator component with green/gray dot and optional label; OnlineUsersList with overlapping avatar stack and overflow counter; PresenceSidebar showing users grouped by module with avatar rows; PresenceWidget integrated into sidebar footer with expandable detail panel and collapsed badge mode; HeaderPresence in header bar showing avatars of users in the same module; presence updates on module navigation without channel re-subscription; automatic cleanup on disconnect via Supabase Realtime), and 119 (Audit Trail & Activity Log — SQL migration 012_activity_log_schema.sql creating immutable activity_log table with project_id, user_id, entity_type, entity_id, action, JSONB details, ip_address, user_agent fields; RLS via is_project_member() for SELECT and INSERT only with no UPDATE/DELETE policies; 5 indexes including composite project+created_at DESC and project+user+created_at; logActivity() server utility in lib/activity/logging.ts using service client with fire-and-forget error handling; formatAction/formatEntityType/getActionColor display utilities in lib/activity/utils.ts mapping 30+ action types to human-readable labels; GET /api/projects/[projectId]/activity-log endpoint with pagination, filtering by user/action/entity_type/entity_id/date_range/search, profile enrichment; ActivityLogViewer component with debounced filter changes and load-more pagination; ActivityFilters with search input, entity type dropdown, action category dropdown, date range pickers; ActivityItem showing user avatar, action label with color coding, entity type badge, timestamp, optional change summary; activity-log page at /org/[orgSlug]/project/[projectId]/activity-log; updated TypeScript types with ActivityLog alias), and 020 (Hall Agent Infrastructure — AI-powered chat panel in The Hall using Anthropic Claude API with streaming responses; agent-panel.tsx as collapsible right sidebar with conversation history loading and persistence via agent_conversations table; agent-message.tsx with user/assistant chat bubbles in dark theme with purple Bot icon and cyan User icon; agent-input.tsx with auto-resizing textarea and Enter-to-send; POST /api/agent/hall/chat streaming endpoint calling Claude Haiku with project idea context injection including titles, bodies, statuses, and tags; GET/PUT /api/agent/hall for conversation history load and save; lib/agent/context.ts with buildHallContext assembling idea portfolio summary and buildSystemPrompt combining role description with live context; system prompt guiding agent to analyze ideas for tags, duplicates, connections, and refinement; context window management keeping last 20 messages; typing indicator with animated dots; error handling with graceful fallback messages; Escape to close panel; mobile full-width with overlay; purple FAB toggle button; @anthropic-ai/sdk dependency added), and 024 (Hall Real-Time Updates — useRealtimeIdeas hook in lib/realtime/use-realtime-ideas.ts subscribing to Supabase postgres_changes on ideas table filtered by project_id for INSERT/UPDATE/DELETE events with stable ref pattern for onChange callback; ConnectionStatus component with green/red dot indicator and Synced/Offline text; real-time event handling wired into hall-client.tsx state: INSERT adds new idea stub to top of list with slide-in animation incrementing total count and deduplication check, UPDATE merges changed fields preserving client-side tags and creator relations with yellow highlight flash, DELETE removes idea from list decrementing total count; CSS keyframe animations in globals.css: highlight-flash with amber box-shadow fade-out over 1s, slide-in with opacity/translateY 300ms ease-out; highlightedIds and newIds Set state with auto-clear timers after 1s cleanup; IdeaGrid and IdeaList updated to accept highlightedIds/newIds props passing through to IdeaCard highlighted prop and IdeaListRow highlighted/isNew props; ConnectionStatus displayed next to Hall header; highlight timer cleanup on unmount via useEffect), and 019 (Bulk Operations — selection checkboxes on IdeaCard grid view with isSelected/onSelect props and cyan border highlight; BulkActionBar floating at bottom center with selection count badge, Tag/Status/Archive action buttons and Deselect X button using glass-panel styling with slide-in animation; BulkTagModal with searchable checkbox tag list applying tags as union operation preserving existing; BulkStatusModal with radio-style status picker for raw/developing/mature with Badge previews; BulkDeleteModal with AlertTriangle confirmation dialog; 4 API routes: POST /api/hall/bulk/tag adding tags to multiple ideas skipping duplicates via existingSet lookup, PUT /api/hall/bulk/status changing status for multiple ideas filtering out promoted/archived, POST /api/hall/bulk/archive soft-deleting multiple ideas returning previousStatuses for undo, POST /api/hall/bulk/unarchive restoring archived ideas to previous statuses; optimistic removal on bulk archive with undo toast; refetch after all bulk operations to sync changes; IdeaGrid updated with selectedIds/onSelectionChange props; all modals use Dialog with open/onOpenChange pattern), and 025 (Hall to Pattern Shop Promotion — SQL migration 013_hall_promotion_schema.sql adding hall_idea_id UUID column to feature_nodes with FK to ideas and filtered index; POST /api/hall/ideas/[ideaId]/promote endpoint validating promotable statuses raw/developing/mature, creating feature_node seed at root level with auto-positioned ordering and hall_idea_id backlink, updating idea status to promoted with promoted_to_seed_id FK to created seed; PromotionWizard 4-step modal component: Step 1 confirms idea details showing title/body/tags with maturity warning hints for raw/developing status, Step 2 selects seed level epic or feature with inferSeedLevel heuristic based on body length and broad-scope keywords, Step 3 edits seed name/description pre-filled from idea with level badge, Step 4 shows success with link to Pattern Shop; IdeaActionButtons updated from disabled placeholder to functional Promote button, promoted banner with View Seed external link shown for promoted ideas, Edit/Archive hidden for promoted status; IdeaDetailSlideOver wired with PromotionWizard opening on promote click and refetching idea after promotion; orgSlug prop threaded through slide-over for promotion links; TypeScript types updated with hall_idea_id on feature_nodes Row/Insert/Update), and 029 (Feature Tree Component — GET /api/projects/[projectId]/feature-tree endpoint fetching all non-deleted feature_nodes for a project with membership validation and server-side tree building via buildTree function grouping by parent_id with recursive position sorting; FeatureTree component in components/shop/feature-tree.tsx managing fetch/loading/error/empty states with expandedIds Set for expand/collapse state tracking; TreeNodeRow recursive memo component in components/shop/tree-node-row.tsx rendering individual nodes with level icons FolderOpen/Puzzle/Layers/CheckCircle2 mapped to epic/feature/sub_feature/task, status color dots using accent-cyan/accent-success/accent-error/text-tertiary for in_progress/complete/blocked/not_started, ChevronDown/ChevronRight expand toggle for nodes with children, depth-based indentation at 16px per level, selected state with accent-cyan/10 background and cyan left border and bold text, hover state with bg-tertiary; ShopLeftPanel updated from placeholder empty state to live FeatureTree with projectId/selectedNodeId/onSelectNode props; ShopClient wired with setSelectedNodeId callback passed through ShopLeftPanel to FeatureTree completing the node selection pipeline to center panel; Trees icon empty state when no feature nodes exist), and 028 (Product Overview Document — GET/PUT /api/projects/[projectId]/product-overview endpoint with lazy initialization creating product_overview requirements_document on first access if missing; PRODUCT_OVERVIEW_TEMPLATE constant in lib/shop/product-overview-template.ts with 5-section HTML template: Business Context, Problem Statement, Target Users, Success Metrics, Key Decisions with italic guidance placeholders; ProductOverviewEditor component in components/shop/product-overview-editor.tsx with contentEditable div rendering HTML, 2-second debounced auto-save via saveTimerRef, save status indicator showing Saving.../Saved with CheckCircle2 icon, word count in toolbar stripped from HTML tags, loading spinner and error retry states; prose-foundry CSS class in globals.css styling h1/h2/p/em/ul/ol/a/strong for dark theme with accent-cyan h2 headings and border-bottom separators; ShopLeftPanel Product Overview button made interactive with accent-cyan/10 selected background using 'product-overview' sentinel value in selectedNodeId; ShopCenterPanel updated to route 'product-overview' to ProductOverviewEditor and feature node IDs to future requirements placeholder; auto-creation of product overview on project creation in POST /api/projects inserting requirements_documents row with template content), and 030 (Add Nodes to Feature Tree — POST /api/projects/[projectId]/feature-nodes endpoint creating feature nodes with auto-calculated level based on parent hierarchy epic->feature->sub_feature->task, auto-positioned via MAX(sibling position)+1, task nodes blocked from having children returning 400 error; PATCH /api/projects/[projectId]/feature-nodes/[nodeId] for inline title updates; DELETE for soft-delete setting deleted_at timestamp; NodeContextMenu custom context menu component in components/shop/node-context-menu.tsx with Add Child and Add Sibling actions plus disabled Edit/Change Level/Delete placeholders for Phase 031, fixed positioning, click-outside and Escape to dismiss; TreeNodeRow updated with Plus button appearing on hover via opacity-0 group-hover:opacity-100 for non-task nodes, right-click triggering context menu via onContextMenu handler, inline title editing with autofocused input replacing title text, Enter to save, Escape to cancel deleting empty untitled nodes, blur auto-saves; FeatureTree updated with editingNodeId state tracking which node is being edited, createNode function POSTing to API then refetching tree and entering edit mode, handleAddChild validating parent can have children, handleAddSibling creating at parent level, handleAddEpic for root-level creation, auto-expanding parent when child added, "Add Epic" button in empty state and at bottom of tree; context menu state with position/nodeId/nodeLevel/parentId), and 033 (Feature Requirements Document — buildFrdTemplate function in lib/shop/frd-template.ts generating 6-section HTML template: Overview, User Story, Requirements, Acceptance Criteria, Out of Scope, Dependencies with italic guidance placeholders; GET/POST /api/projects/[projectId]/requirements-documents with featureNodeId and docType query filters using DocType casting for typed Supabase queries, POST creating FRD with auto-template from feature node title and 409 Conflict if FRD already exists for that node; GET/PUT /api/projects/[projectId]/requirements-documents/[docId] for individual document retrieval and title/content updates with project membership validation; FeatureRequirementEditor component with auto-creation logic fetching FRD list by featureNodeId and auto-POSTing to create if none found with 409 race-condition re-fetch handling, contentEditable div with 2-second debounced auto-save, save status indicator with Save icon pulse and CheckCircle2 Saved confirmation, word count in toolbar stripped from HTML tags; ShopCenterPanel updated to route feature node selections to FeatureRequirementEditor with key={selectedNodeId} forcing remount on node change to avoid stale contentEditable state) are complete and committed.

---

## Section 2: Key Files to Read

> Customize per phase. Include the files relevant to the phase being built, plus the universal files every session should read.

### Universal (include in every prompt)
* types/database.ts — full database types
* lib/supabase/server.ts — createClient, createServiceClient patterns
* lib/auth/server.ts — requireAuth, requireAuthWithProfile
* lib/auth/errors.ts — handleAuthError
* lib/auth/context.tsx — AuthProvider, useAuth, useOptionalAuth
* lib/utils.ts — cn helper, timeAgo utility
* app/globals.css — brand colors and theme variables

### Hall Track
* components/hall/hall-client.tsx — HallClient orchestrator
* components/hall/idea-detail-slide-over.tsx — Phase 016 slide-over
* components/hall/idea-action-buttons.tsx — Edit/Archive/Promote buttons
* components/hall/idea-create-modal.tsx — Phase 013 create modal with tag selection
* components/hall/idea-card.tsx — IdeaCard with glass-panel styling
* components/hall/idea-grid.tsx and idea-list.tsx — grid/list views
* components/hall/hall-header.tsx — header with search, view toggle
* components/hall/filter-bar.tsx — status/sort/tag filters
* components/hall/tag-filter.tsx — tag filter dropdown
* components/hall/types.ts — IdeaWithDetails, STATUS_CONFIG, SORT_OPTIONS
* app/org/[orgSlug]/project/[projectId]/hall/page.tsx — server component
* app/api/hall/ideas/route.ts — GET/POST endpoints
* app/api/hall/ideas/[ideaId]/route.ts — GET single idea
* app/api/hall/tags/route.ts — GET project tags

### Schema Track
* supabase/migrations/002_core_schema.sql — core schema patterns (is_project_member, RLS)
* supabase/migrations/003_hall_schema.sql — Hall schema patterns (CHECK constraints, SECURITY DEFINER helpers)

### Admin Track
* lib/permissions/definitions.ts — permission definitions
* lib/permissions/hooks.ts — usePermission hook
* lib/permissions/server.ts — requireOrgPermission, requireProjectPermission
* components/layout/app-layout.tsx — AppLayout shell
* components/layout/sidebar.tsx — sidebar component
* components/layout/header.tsx — header with breadcrumbs
* components/layout/user-menu.tsx — UserMenu with role badges
* app/org/[orgSlug]/layout.tsx — org-level layout

### UI Components (include when building UI-heavy phases)
* components/ui/dialog.tsx — Dialog modal
* components/ui/toast-container.tsx — ToastProvider, useToast
* components/ui/button.tsx — Button with variants, sizes, isLoading
* components/ui/input.tsx — Input with labels, error
* components/ui/select.tsx — Select dropdown
* components/ui/badge.tsx — Badge with 7 variants
* components/ui/card.tsx — Card composable
* components/ui/avatar.tsx — Avatar with gradient fallback
* components/ui/empty-state.tsx — EmptyState component

---

## Section 3: Conventions & Patterns

> Include all of these in every prompt. Add new conventions as they're discovered.

1. Next.js 16.1.6 with App Router, Turbopack, React 19, TypeScript strict mode
2. Tailwind CSS v4 with CSS-first config via @theme in globals.css (NOT tailwind.config.ts)
3. Brand colors are CSS custom properties: bg-primary #0f1117, bg-secondary #1a1d27, bg-tertiary #252830, text-primary #e4e7ec, text-secondary #8b8fa3, text-tertiary #5a5f73, accent-cyan #00d4ff, accent-purple #8b5cf6, accent-success/warning/error
4. Supabase for auth + PostgreSQL with RLS; service role client bypasses RLS for API routes
5. API routes use requireAuth() from lib/auth/server.ts and createServiceClient() from lib/supabase/server.ts
6. cn() helper in lib/utils.ts combines clsx + tailwind-merge
7. Database types in types/database.ts with convenience aliases (Idea, Tag, IdeaTag, etc.)
8. Glass panel styling via glass-panel CSS class for cards
9. Toast system: useToast() hook -> addToast(message, type) where type is 'success' | 'error' | 'info' | 'warning'
10. Button component supports isLoading prop with spinner, 5 variants (primary/secondary/ghost/danger/outline), 3 sizes
11. AppLayout is already wired into project layout — don't re-wrap module pages with it
12. React 19 ESLint: don't call setState directly inside useEffect body — wrap in async function instead (see doFetch pattern in hall-client.tsx). Use useSyncExternalStore for browser-only values like navigator.platform
13. Next.js ESLint rule: don't use `module` as a variable name — use activeModule or similar
14. RLS for tenant isolation only — business logic in Next.js API routes
15. Service role key bypasses RLS for admin/API route operations
16. useOptionalOrg and useOptionalProject hooks exist for components rendered outside their providers
17. useOptionalAuth hook in lib/auth/context.tsx is a non-throwing variant of useAuth for defensive rendering
18. React 19 refs rule: don't assign to ref.current during render — use useEffect to sync
19. Schema phases: use CHECK constraints for status/type columns (NOT CREATE TYPE enums). Follow Hall schema pattern.
20. Schema phases: use is_project_member() SECURITY DEFINER helper for RLS (NOT direct project_members queries). Create new SECURITY DEFINER helpers for junction/child tables.
21. Schema phases: add auto-update triggers for updated_at columns
22. Phase spec file structure may reference `src/` — this project does NOT use `src/`. Components go in `components/`, pages in `app/`, API routes in `app/api/`.
23. This project does NOT use a `tailwind.config.ts` file. All theme configuration is done via CSS @theme in globals.css.

---

## Section 4: Post-Build Instructions

> Include at the end of every prompt.

After building, run `npm run build` and `npm run lint` to verify zero errors. Then give me:
* A local link to the app
* What's new since the last completed phase
* What I can test (include full clickable URLs like http://localhost:3000/login so they're easy to click)
* Ask me if I want any changes before moving on
* Then ask: "Ready to create a commit message with bullet points and push to GitHub?"

---

## Section 5: Sequential Build Instructions

> Include at the top of every prompt.

**IMPORTANT**: Build directly on `main` branch. No feature branches or worktrees. Commit directly to main after build + lint pass.

---

## Section 6: Sequential Execution Queue

> Updated after each phase completes. Next = first incomplete phase in the list.

**Completed**:
- Phase 017: Edit & Delete Ideas (Hall) -- done
- Phase 026: Pattern Shop Database Schema (Shop) -- done
- Phase 018: Tagging & Tag Management (Hall) -- done
- Phase 027: Pattern Shop Page Layout (Shop) -- done
- Phase 061: Assembly Floor DB Schema (Floor) -- done
- Phase 081: Insights Lab DB Schema (Lab) -- done
- Phase 046: Control Room DB Schema (Room) -- done
- Phase 096: Artifacts DB & Storage (Cross) -- done
- Phase 105: Comments System Foundation (Cross) -- done
- Phase 109: Knowledge Graph Schema (Cross) -- done
- Phase 113: Organization Console (Admin) -- done
- Phase 117: Real-Time Presence (Realtime) -- done
- Phase 119: Audit Trail & Activity Log (Admin) -- done
- Phase 020: Hall Agent Infrastructure (Hall) -- done
- Phase 024: Hall Real-Time Updates (Hall) -- done
- Phase 019: Bulk Operations (Hall) -- done
- Phase 025: Hall -> Shop Promotion (Hall/Shop) -- done
- Phase 029: Feature Tree Component (Shop) -- done
- Phase 028: Product Overview Document (Shop) -- done
- Phase 030: Add Nodes to Feature Tree (Shop) -- done
- Phase 033: Feature Requirements Doc (Shop) -- done

**Next up** (in priority order):
20. Phase 062: Assembly Floor Page Layout (Floor)
