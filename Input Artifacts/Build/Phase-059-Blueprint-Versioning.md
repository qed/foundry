# Phase 059 - Blueprint Version History

**Objective:** Implement blueprint versioning with history tracking, diff viewing, and rollback capability.

**Prerequisites:**
- Phase 046 (Database schema with blueprint_versions table)
- Phase 049 (Blueprint editor with auto-save)
- Phase 054 (Blueprint status tracking)

**Context:**
Blueprint versioning tracks all changes to blueprints over time. Engineers can view version history, compare versions, and restore to previous versions if needed. Auto-save creates versions automatically, and major milestones (status changes, reviews) are marked in history. Version history supports collaboration and provides an audit trail.

**Detailed Requirements:**

1. **Auto-Versioning**
   - Trigger: Blueprint content changes (via auto-save)
   - Debounce: Save version only if 2+ minutes have passed since last version
     - Purpose: avoid creating too many versions for rapid edits
   - Version number: auto-increment per blueprint (starts at 1)
   - Each version stores:
     - version_number (integer)
     - content (full snapshot of blueprint content at this version)
     - created_by (user_id)
     - created_at (timestamp)
     - change_note (optional, user-provided note)

2. **Manual Version Creation**
   - When user performs significant action, optionally create version:
     - Status change: "Moved to In Review"
     - Agent generation: "Generated by Control Room Agent"
     - Agent suggestions applied: "Applied AI suggestions"
   - Dialog: "Create version?"
     - Version note input (optional, max 100 chars)
     - "Create Version" button
     - "Skip" button

3. **Version History Panel**
   - Access: Click "History" button or icon in blueprint header
   - Displays: List of versions with metadata
   - Each version item shows:
     - Version number (e.g., "Version 5")
     - Created by: [User Name] avatar
     - Timestamp: relative (e.g., "2 hours ago") and absolute (hover)
     - Change note: if provided (e.g., "Fixed API endpoint errors")
     - Preview: small snippet of first change in this version (optional)
   - Versions listed newest first (reverse chronological)
   - Current version highlighted or marked as "Current"

4. **Version History UI**
   - Layout: side panel (30% width) or modal dialog
   - Header: "Version History" with close button (X)
   - List of versions (scrollable)
   - Selected version details on right (or below):
     - Version number and metadata
     - "Diff with current" link (shows changes)
     - "Restore to this version" button
     - "Preview" button (show content in preview mode)
   - Action buttons for selected version:
     - Restore (with confirmation)
     - Compare (diff with current or previous)
     - Download (export as markdown)

5. **Diff View**
   - Shows: side-by-side or unified diff of two versions
   - Left side: previous version content
   - Right side: current version content
   - Changes highlighted:
     - Additions: green background, +
     - Deletions: red background, -
     - Unchanged: gray text
   - Line-by-line view with line numbers
   - Context: 3 lines of unchanged content above/below each change
   - Collapse/expand sections to focus on changes
   - Filter: show only changes to specific sections (optional)

6. **Comparison Options**
   - User can compare:
     - Any version vs. current version
     - Any two versions (version picker dropdown)
     - Version vs. previous version (default)
   - Show statistics:
     - Lines added/removed/changed
     - Character count
     - Sections modified

7. **Restore to Previous Version**
   - Click "Restore to this version" button:
     - Confirmation dialog: "Restore to Version X? This will replace current content."
     - Warning: "This action cannot be undone without saving current content."
     - "Restore" button
   - On restore:
     - Current content backed up (new version created automatically)
     - Blueprint content replaced with restored version
     - Editor content updates
     - History shows: "[User] restored to Version X"
     - Status: remains as-is (doesn't revert status)

8. **Version Metadata**
   - Track in blueprint_activities or within blueprint_versions:
     - trigger: what caused this version (edit, status_change, ai_generated, ai_review)
     - user_id: who created this version
     - change_note: optional note about the change
     - status_at_version: what was the blueprint status at this version

9. **Version Cleanup** (future, optional)
   - Keep: all versions indefinitely (safer)
   - Or: keep last 30 days of versions, then archive old versions
   - Configurable per org

10. **Timeline View** (alternative to list view, optional)
    - Show versions as timeline:
      - Vertical line showing time progression
      - Each version as point on timeline
      - Click point to view version details
      - Color-coded by event type (edit, status change, etc.)

11. **Version Download**
    - Click "Download" on version:
      - Format: Markdown file
      - Filename: "[BlueprintTitle]_v[version].md"
      - Includes: version number, created date, author
      - Content: full blueprint at that version

12. **Pagination & Performance**
    - Load versions in batches (20 per batch)
    - "Load More Versions" button to load older versions
    - Or: infinite scroll loading

13. **Mobile/Responsive**
    - Desktop: side-by-side history and detail
    - Tablet: stacked history above detail
    - Mobile: modal for history (full screen)

14. **Accessibility**
    - Version list has role="list"
    - Each version has role="listitem"
    - Restore button has aria-label="Restore to version X"
    - Diff view: semantic markup for additions (green) and deletions (red)
    - Keyboard navigation: Tab through versions, Enter to select

15. **Search Versions**
    - Optional: search version history by change note
    - Filter by user (who made changes)
    - Filter by date range
    - Filter by event type (edits, status changes, etc.)

**Database Schema**
```sql
-- blueprint_versions table (from Phase 046)
CREATE TABLE blueprint_versions (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  blueprint_id UUID NOT NULL REFERENCES blueprints(id) ON DELETE CASCADE,
  version_number INTEGER NOT NULL,
  content JSONB NOT NULL,
  created_by UUID NOT NULL REFERENCES auth.users(id),
  created_at TIMESTAMP NOT NULL DEFAULT now(),
  change_note TEXT,
  trigger_type VARCHAR(50), -- 'edit', 'status_change', 'ai_generated', 'ai_review'

  UNIQUE (blueprint_id, version_number)
);

-- Index for efficient version lookup
CREATE INDEX idx_blueprint_versions_blueprint_id_desc
ON blueprint_versions(blueprint_id, version_number DESC);

-- RLS (from Phase 046)
CREATE POLICY blueprint_versions_select ON blueprint_versions
  FOR SELECT
  USING (
    EXISTS (
      SELECT 1 FROM blueprints b
      INNER JOIN project_members pm ON b.project_id = pm.project_id
      WHERE b.id = blueprint_versions.blueprint_id
      AND pm.user_id = auth.uid()
    )
  );
```

**Triggers**
```sql
-- Trigger to auto-create version on blueprint update
CREATE OR REPLACE FUNCTION auto_version_on_blueprint_update()
RETURNS TRIGGER AS $$
DECLARE
  last_version_created_at TIMESTAMP;
  latest_version_number INTEGER;
BEGIN
  -- Check if last version was created more than 2 minutes ago
  SELECT created_at INTO last_version_created_at
  FROM blueprint_versions
  WHERE blueprint_id = NEW.id
  ORDER BY version_number DESC
  LIMIT 1;

  -- If no versions exist or last version is older than 2 minutes, create new version
  IF last_version_created_at IS NULL OR
     (now() - last_version_created_at) >= interval '2 minutes'
  THEN
    -- Get next version number
    SELECT COALESCE(MAX(version_number), 0) + 1 INTO latest_version_number
    FROM blueprint_versions
    WHERE blueprint_id = NEW.id;

    -- Insert new version
    INSERT INTO blueprint_versions (blueprint_id, version_number, content, created_by, trigger_type)
    VALUES (NEW.id, latest_version_number, NEW.content, auth.uid(), 'edit');
  END IF;

  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER blueprint_auto_version_trigger
AFTER UPDATE OF content ON blueprints
FOR EACH ROW
WHEN (NEW.content IS DISTINCT FROM OLD.content)
EXECUTE FUNCTION auto_version_on_blueprint_update();
```

**API Routes**
```
GET /api/projects/[projectId]/blueprints/[blueprintId]/versions
  Query:
    - limit?: number (default 20)
    - offset?: number (default 0)
  Returns: {
    versions: [
      {
        version_number,
        created_by: { id, name, avatar_url },
        created_at,
        change_note,
        trigger_type
      }
    ],
    total: number
  }

GET /api/projects/[projectId]/blueprints/[blueprintId]/versions/[versionNumber]
  Returns: { version_number, content, created_by, created_at, change_note }

GET /api/projects/[projectId]/blueprints/[blueprintId]/versions/diff
  Query:
    - from_version: number (required)
    - to_version: number (required, default current)
  Returns: {
    from: { version_number, content },
    to: { version_number, content },
    diff: [
      { type: 'add' | 'delete' | 'context', line_number, content }
    ]
  }

POST /api/projects/[projectId]/blueprints/[blueprintId]/versions/[versionNumber]/restore
  Returns: { message: "Restored to version X", new_version_number }

GET /api/projects/[projectId]/blueprints/[blueprintId]/versions/[versionNumber]/download
  Returns: file (markdown)
```

**UI Components**
- `BlueprintVersionHistory` (main version history panel)
- `VersionHistoryList` (list of versions)
- `VersionHistoryItem` (single version item)
- `VersionDiffView` (diff view component)
- `DiffViewer` (syntax-highlighted diff display)
- `RestoreVersionDialog` (confirmation dialog)
- `VersionComparison` (compare two versions)
- `VersionMetadata` (shows version info)

**File Structure**
```
app/
  api/
    projects/
      [projectId]/
        blueprints/
          [blueprintId]/
            versions/
              route.ts (GET versions list)
              [versionNumber]/
                route.ts (GET version details)
                restore/
                  route.ts (POST restore)
                download/
                  route.ts (GET download)
              diff/
                route.ts (GET diff between versions)
  components/
    room/
      BlueprintVersionHistory.tsx
      VersionHistoryList.tsx
      VersionHistoryItem.tsx
      VersionDiffView.tsx
      RestoreVersionDialog.tsx
  lib/
    utils/
      diff.ts (compute text diff algorithm)
```

**Acceptance Criteria**
- [ ] Version automatically created on blueprint content save (every 2+ minutes)
- [ ] Version number auto-increments per blueprint
- [ ] First blueprint has version 1
- [ ] History button/icon visible in blueprint header
- [ ] Clicking history button opens version history panel
- [ ] Version list shows versions newest first
- [ ] Each version shows: number, author, timestamp, change note
- [ ] Clicking version shows diff with current version
- [ ] Diff shows additions in green, deletions in red
- [ ] Diff shows context (3 lines above/below changes)
- [ ] "Restore to this version" button available on each version
- [ ] Restore dialog shows confirmation
- [ ] Confirming restore replaces blueprint content
- [ ] Auto-save doesn't create too many versions (2-minute debounce)
- [ ] Version count doesn't grow excessively with rapid edits
- [ ] Multiple users can view version history simultaneously
- [ ] Status changes create version with trigger_type='status_change'
- [ ] Agent-generated blueprints have trigger_type='ai_generated'
- [ ] Agent suggestions have trigger_type='ai_review'
- [ ] Download version as markdown works
- [ ] Restore creates backup version before restoring
- [ ] RLS prevents accessing versions of other project's blueprints
- [ ] Pagination loads older versions on demand
- [ ] Timeline view shows all versions on timeline (if implemented)

**Testing Instructions**
1. Open blueprint in editor
2. Edit content and wait 2 minutes for auto-save
3. Click History button and verify version list appears
4. Verify first version shows in history
5. Make another edit and wait 2 minutes
6. Verify second version appears in history
7. Click second version and verify shows in list
8. Click "Show Diff" and verify diff view displays
9. Verify diff shows changes between versions
10. Verify additions highlighted in green
11. Verify deletions highlighted in red
12. Click version 1 and verify diff shows against current version
13. Click "Restore to this version" button
14. Verify confirmation dialog appears
15. Click confirm and verify blueprint reverts to previous version
16. Verify editor content updates
17. Verify history shows restore action
18. Click "Download" button and verify markdown file downloads
19. Verify downloaded file includes version number and author
20. Make rapid edits and verify only one version created per 2 minutes
21. Change blueprint status to In Review
22. Verify version created with trigger_type='status_change'
23. Use agent to generate blueprint
24. Verify version created with trigger_type='ai_generated'
25. Test with multiple users viewing same blueprint
26. Verify both users see same version history
27. One user restores old version
28. Verify other user sees update in real-time (if realtime enabled)
29. Create blueprint with many versions (10+)
30. Verify pagination loads older versions
31. Compare two non-consecutive versions
32. Verify diff shows all changes between versions
33. Verify version timestamps are accurate
34. Verify user avatars show on each version
35. Test download of old version
36. Verify RLS: non-project-member cannot view versions
